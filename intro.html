<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I: The Mitochondrial Command Center</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
        
        body { 
            background-color: #020617; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-family: 'Inter', sans-serif;
        }
        
        .protein-label { 
            font-size: 10px; 
            line-height: 1.1; 
            font-weight: 800;
            white-space: nowrap; 
            pointer-events: none;
            width: auto;
            min-width: 80px;
        }

        .bracket-container {
            position: absolute;
            bottom: 22%;
            left: 0;
            right: 0;
            height: 36px;
            display: flex;
            pointer-events: none;
            padding: 0 3rem;
        }
        .bracket {
            border: 3px solid #1e293b;
            border-top: none;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 6px;
            font-weight: 900;
            font-size: 13px;
            letter-spacing: 0.05em;
            color: #1e293b;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        @keyframes turbine-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-turbine {
            animation: turbine-rotate 3s linear infinite;
        }

        .active-target-highlight {
            filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.8));
            border-color: #ef4444 !important;
        }
    </style>
</head>
<body>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [currentStep, setCurrentStep] = useState(0);
            const [completedTerms, setCompletedTerms] = useState([]);
            const [availableTerms, setAvailableTerms] = useState([]);
            const audioContextRef = useRef(null);
            
            const gameSequence = [
                { text: "electron transport chain", type: "essay" },
                { text: "chemiosmosis", type: "essay" },
                { text: "inner membrane of mitochondria", type: "essay" },
                { text: "NADH dehydrogenase", type: "protein" },
                { text: "succinate dehydrogenase", type: "protein" },
                { text: "coenzyme Q", type: "protein" },
                { text: "cytochrome c reductase", type: "protein" },
                { text: "cytochrome c", type: "protein" },
                { text: "cytochrome c oxidase", type: "protein" },
                { text: "ATP synthase", type: "protein" }
            ];

            const speakStep = (stepNumber) => {
                const messages = {
                    0: "Identify the stages of oxidative phosphorylation?",
                    1: "Identify the second stage of oxidative phosphorylation.",
                    2: "Locate where this process occurs in the cell.",
                    3: "Identify the components of the electron transport chain.",
                    9: "Identify the enzyme involved in chemiosmosis."
                };
                const text = messages[stepNumber];
                if (!text) return;
                
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1;
                window.speechSynthesis.speak(utterance);
            };

            const initAudio = async () => {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContextRef.current.state === 'suspended') {
                    await audioContextRef.current.resume();
                }
            };

            const playSound = async (type) => {
                try {
                    await initAudio();
                    const ctx = audioContextRef.current;
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    if (type === 'correct') {
                        osc.frequency.setValueAtTime(600, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    } else {
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, ctx.currentTime);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    }
                    osc.start();
                    osc.stop(ctx.currentTime + 0.2);
                } catch(e) {}
            };

            useEffect(() => {
                const shuffled = [...gameSequence].map(item => item.text).sort(() => Math.random() - 0.5);
                setAvailableTerms(shuffled);
                speakStep(0);
            }, []);

            useEffect(() => {
                if ([0, 1, 2, 3, 9].includes(currentStep)) {
                    speakStep(currentStep);
                }
            }, [currentStep]);

            const handleDrop = async (e, targetName) => {
                e.preventDefault();
                const draggedText = e.dataTransfer.getData("text");
                const expected = gameSequence[currentStep];

                if (draggedText.toLowerCase() === expected.text.toLowerCase()) {
                    playSound('correct');
                    setCompletedTerms([...completedTerms, draggedText]);
                    setAvailableTerms(availableTerms.filter(t => t !== draggedText));
                    setCurrentStep(currentStep + 1);
                } else {
                    playSound('wrong');
                }
            };

            const formatDisplay = (text) => {
                const lower = text.toLowerCase();
                return lower
                    .replace("nadh", "NADH")
                    .replace("coenzyme q", "coenzyme Q")
                    .replace("atp", "ATP");
            };

            const goHome = () => {
                window.location.href = "./index.html";
            };

            return (
                <div className="flex flex-col h-full bg-slate-950 p-6 overflow-hidden">
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex flex-col">
                            <h2 className="text-3xl font-black text-white uppercase tracking-tighter">I: The Mitochondrial Command Center</h2>
                            <div className="flex items-center gap-3">
                                <span className="text-sky-400 text-sm font-bold tracking-widest">Drag the labels to complete the essay and diagram.</span>
                            </div>
                        </div>
                        <div className="flex gap-4">
                            {availableTerms.length === 0 && (
                                <button 
                                    onClick={goHome}
                                    className="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-black rounded-xl uppercase text-xs tracking-widest transition-all shadow-xl animate-bounce border-b-4 border-emerald-800"
                                >
                                    Command center secured! Return to HQ â†’
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="flex flex-1 gap-6 overflow-hidden">
                        <div className="flex-1 relative border-[10px] border-slate-900 rounded-[3rem] overflow-hidden flex flex-col shadow-2xl bg-white">
                            <div className="h-[22%] bg-amber-50 relative flex items-center border-b-[4px] border-amber-100 px-10">
                                <span className="text-xs font-black text-black tracking-[0.05em] bg-white/40 px-2 py-0.5 rounded absolute left-10">Intermembrane Space</span>
                            </div>

                            <div className="h-[45%] bg-amber-100 relative flex items-center justify-start gap-8 px-56 border-y-[4px] border-amber-200">
                                <span className="absolute bottom-4 left-10 text-xs font-black text-black tracking-[0.05em] bg-white/40 px-2 py-0.5 rounded">Inner Membrane</span>
                                
                                <Protein type="integral" name="NADH dehydrogenase" active={currentStep===3} done={completedTerms.includes("NADH dehydrogenase")} onDrop={handleDrop} formatFn={formatDisplay} />
                                <Protein type="peripheral-matrix" name="succinate dehydrogenase" active={currentStep===4} done={completedTerms.includes("succinate dehydrogenase")} onDrop={handleDrop} formatFn={formatDisplay} />
                                <Protein type="small" name="coenzyme Q" active={currentStep===5} done={completedTerms.includes("coenzyme Q")} onDrop={handleDrop} formatFn={formatDisplay} />
                                <Protein type="integral" name="cytochrome c reductase" active={currentStep===6} done={completedTerms.includes("cytochrome c reductase")} onDrop={handleDrop} formatFn={formatDisplay} />
                                <Protein type="surface" name="cytochrome c" active={currentStep===7} done={completedTerms.includes("cytochrome c")} onDrop={handleDrop} formatFn={formatDisplay} />
                                <Protein type="integral" name="cytochrome c oxidase" active={currentStep===8} done={completedTerms.includes("cytochrome c oxidase")} onDrop={handleDrop} formatFn={formatDisplay} />
                                
                                <div className="ml-auto pr-8 h-full flex items-center">
                                    <Protein type="turbine" name="ATP synthase" active={currentStep===9} done={completedTerms.includes("ATP synthase")} onDrop={handleDrop} formatFn={formatDisplay} />
                                </div>
                            </div>

                            <div className="h-[33%] bg-emerald-50 relative border-t-[4px] border-emerald-100">
                                <span className="absolute bottom-4 left-10 text-xs font-black text-black tracking-[0.05em] bg-white/40 px-2 py-0.5 rounded">Matrix</span>
                                
                                {currentStep >= 2 && (
                                    <div className="bracket-container animate-in fade-in zoom-in duration-500" style={{ paddingLeft: '14rem', paddingRight: '1rem' }}>
                                        <div className="bracket w-[68%] rounded-b-2xl">Electron Transport Chain</div>
                                        <div className="bracket w-[20%] rounded-b-2xl ml-auto mr-[5rem]">Chemiosmosis</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 p-8 bg-slate-900 rounded-[2rem] border border-slate-800 shadow-xl relative overflow-hidden font-bold">
                        <div className="text-white mb-6 min-h-[10rem]">
                            <div className="text-xl leading-relaxed space-y-4">
                                <div className="animate-in slide-in-from-left duration-500">
                                    1. Oxidative phosphorylation consists of <Drop target="electron transport chain" done={completedTerms.includes("electron transport chain")} active={currentStep===0} onDrop={handleDrop} formatFn={formatDisplay} /> and <Drop target="chemiosmosis" done={completedTerms.includes("chemiosmosis")} active={currentStep===1} onDrop={handleDrop} formatFn={formatDisplay} />.
                                </div>
                                {currentStep >= 2 && (
                                    <div className="animate-in slide-in-from-top-2 duration-700">
                                        2. This process occurs at <Drop target="inner membrane of mitochondria" done={completedTerms.includes("inner membrane of mitochondria")} active={currentStep===2} onDrop={handleDrop} formatFn={formatDisplay} />.
                                    </div>
                                )}
                                {(currentStep >= 3) && (
                                    <div className="animate-in slide-in-from-top-2 duration-700 text-white">
                                        3. The components of ETC are <Drop target="NADH dehydrogenase" done={completedTerms.includes("NADH dehydrogenase")} active={currentStep===3} onDrop={handleDrop} formatFn={formatDisplay} />, <Drop target="succinate dehydrogenase" done={completedTerms.includes("succinate dehydrogenase")} active={currentStep===4} onDrop={handleDrop} formatFn={formatDisplay} />, <Drop target="coenzyme Q" done={completedTerms.includes("coenzyme Q")} active={currentStep===5} onDrop={handleDrop} formatFn={formatDisplay} />, <Drop target="cytochrome c reductase" done={completedTerms.includes("cytochrome c reductase")} active={currentStep===6} onDrop={handleDrop} formatFn={formatDisplay} />, <Drop target="cytochrome c" done={completedTerms.includes("cytochrome c")} active={currentStep===7} onDrop={handleDrop} formatFn={formatDisplay} /> and <Drop target="cytochrome c oxidase" done={completedTerms.includes("cytochrome c oxidase")} active={currentStep===8} onDrop={handleDrop} formatFn={formatDisplay} />.
                                    </div>
                                )}
                                {currentStep >= 9 && (
                                    <div className="animate-in slide-in-from-top-2 duration-700 text-white">
                                        4. Meanwhile, chemiosmosis involves <Drop target="ATP synthase" done={completedTerms.includes("ATP synthase")} active={currentStep===9} onDrop={handleDrop} formatFn={formatDisplay} />.
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex flex-wrap gap-4 justify-center">
                            {availableTerms.map((t, i) => (
                                <div key={i} draggable onDragStart={(e) => { e.dataTransfer.setData("text", t); }} className="px-6 py-3 bg-sky-600 hover:bg-sky-500 text-white rounded-xl font-black text-sm cursor-grab active:scale-95 transition-all uppercase tracking-widest shadow-lg border-b-4 border-sky-800">
                                    {t}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Drop = ({ target, done, active, onDrop, formatFn }) => (
            <span onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, target)} className={`inline-flex items-center justify-center min-w-[160px] px-3 mx-1 rounded-lg transition-all border-2 align-middle font-black text-base ${done ? "text-sky-300 border-sky-500/30 bg-sky-500/10" : active ? "border-red-400 border-dashed bg-red-500/20 animate-pulse text-red-500 text-xl" : "border-slate-700 border-dashed bg-slate-800/50 text-transparent h-7"}`}>
                {done ? formatFn(target) : (active ? "?" : "")}
            </span>
        );

        const Protein = ({ type, name, active, done, onDrop, formatFn }) => {
            const label = formatFn(name);
            let base = "relative flex flex-col items-center justify-center transition-all duration-500 ";
            let visual = done ? "bg-gradient-to-b from-sky-400 to-sky-600 border-sky-300 ring-2 ring-white/20 shadow-lg" : "bg-slate-200 border-slate-300 opacity-40 grayscale shadow-md";
            const activeClass = active ? "active-target-highlight opacity-100 grayscale-0 z-50" : "";
            
            if (type === "integral") {
                return (
                    <div className={`${base} w-16 h-[130%] rounded-2xl border-2 ${visual} ${activeClass}`} onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, name)}>
                        <div className={`protein-label text-center px-1 transition-all ${done ? 'text-black' : (active ? 'text-red-600 text-2xl font-black scale-125' : 'text-slate-500')}`}>
                            {done ? label : (active ? "?" : "")}
                        </div>
                    </div>
                );
            }
            
            if (type === "peripheral-matrix") {
                return (
                    <div className="relative flex flex-col items-center self-end -mb-8 h-20" onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, name)}>
                        <div className={`protein-label text-center mb-1 transition-all min-h-[2.5rem] flex items-end justify-center ${done ? 'text-black' : (active ? 'text-red-600 text-2xl font-black' : 'text-slate-400 opacity-0')}`}>
                            {done ? label : (active ? "?" : "")}
                        </div>
                        <div className={`w-16 h-12 rounded-2xl border-2 transition-all duration-500 ${visual} ${activeClass}`}>
                             {!done && active && <div className="flex items-center justify-center h-full text-red-600 font-black text-2xl">?</div>}
                        </div>
                    </div>
                );
            }

            if (type === "small") {
                return (
                    <div className={`${base} w-14 h-14 rounded-full border-2 ${visual} ${activeClass}`} onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, name)}>
                        <div className={`protein-label text-center px-1 transition-all ${done ? 'text-black' : (active ? 'text-red-600 text-2xl font-black scale-125' : 'text-slate-500')}`}>
                            {done ? label : (active ? "?" : "")}
                        </div>
                    </div>
                );
            }

            if (type === "surface") {
                return (
                    <div className={`${base} w-12 h-12 rounded-full self-start -mt-8 border-2 ${visual} ${activeClass}`} onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, name)}>
                        <div className={`protein-label text-center px-1 transition-all ${done ? 'text-black' : (active ? 'text-red-600 text-2xl font-black scale-125' : 'text-slate-500')}`}>
                            {done ? label : (active ? "?" : "")}
                        </div>
                    </div>
                );
            }

            if (type === "turbine") {
                const turbineColor = done ? "from-purple-400 to-purple-600 border-purple-300" : "from-slate-200 to-slate-300 border-slate-300 grayscale opacity-40";
                const turbineActive = active ? "filter drop-shadow(0 0 10px rgba(239, 68, 68, 0.9)) border-red-500 opacity-100 grayscale-0" : "";
                return (
                    <div className={`relative flex flex-col items-center transition-all duration-500 w-16 h-full ${active ? 'z-50' : ''}`} onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, name)}>
                        <div className={`w-14 h-1/2 border-2 bg-gradient-to-b ${turbineColor} ${turbineActive} rounded-lg shadow-sm flex items-center justify-center relative -mt-10`}>
                            <div className="absolute inset-0 flex justify-around px-1 py-2 opacity-30">
                                <div className="w-1 bg-white h-full rounded-full"></div>
                                <div className="w-1 bg-white h-full rounded-full"></div>
                                <div className="w-1 bg-white h-full rounded-full"></div>
                            </div>
                        </div>
                        <div className={`w-4 h-6 border-x-2 bg-gradient-to-b ${turbineColor} ${turbineActive}`}></div>
                        <div className={`w-20 h-20 -mt-2 border-2 bg-gradient-to-b ${turbineColor} ${turbineActive} rounded-full shadow-lg flex items-center justify-center relative`}>
                             <div className={`absolute inset-0 ${done ? 'animate-turbine' : ''} opacity-20`}>
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-2 h-full bg-white"></div>
                                <div className="absolute left-0 top-1/2 -translate-y-1/2 w-full h-2 bg-white"></div>
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-2 h-full bg-white rotate-45"></div>
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-2 h-full bg-white -rotate-45"></div>
                             </div>
                             <div className={`protein-label text-center px-1 z-10 ${done ? 'text-white' : (active ? 'text-red-600 text-3xl font-black' : 'text-slate-500')}`}>
                                {done ? label : (active ? "?" : "")}
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
