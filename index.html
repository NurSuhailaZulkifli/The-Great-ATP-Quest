<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Great ATP Conquest</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
        .cursor-grab:active { cursor: grabbing; }
        
        body { 
            background-color: #020617; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-family: 'Inter', sans-serif;
        }
        
        /* UPDATED TO SEARCH FOR .png AND ADDED FALLBACK GRADIENT */
        .conquest-bg {
            background-color: #020617;
            background-image: 
                linear-gradient(rgba(15, 23, 42, 0.4), rgba(15, 23, 42, 0.7)),
                url('Mitochondria epic.png'), /* Exact match for your filename */
                linear-gradient(45deg, #0f172a 0%, #1e293b 100%); /* Fallback if image missing */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 3rem;
            padding: 4rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            z-index: 10;
        }

        .text-step-instruction { 
            font-size: 22px; 
            line-height: 1.5;
            color: #1e293b;
        }
        
        .protein-label { 
            font-size: 11px; 
            line-height: 1.1; 
            font-weight: 900;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [currentStep, setCurrentStep] = useState(0);
            const [completedTerms, setCompletedTerms] = useState([]);
            const [availableTerms, setAvailableTerms] = useState([]);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [gameStarted, setGameStarted] = useState(false);
            const audioContextRef = useRef(null);
            const apiKey = ""; 

            const gameSequence = [
                { text: "electron transport chain", type: "essay" },
                { text: "chemiosmosis", type: "essay" },
                { text: "inner membrane of mitochondria", type: "essay" },
                { text: "NADH dehydrogenase", type: "protein" },
                { text: "succinate dehydrogenase", type: "protein" },
                { text: "coenzyme Q", type: "protein" },
                { text: "cytochrome c reductase", type: "protein" },
                { text: "cytochrome c", type: "protein" },
                { text: "cytochrome c oxidase", type: "protein" },
                { text: "ATP synthase", type: "protein" }
            ];

            const initAudio = async () => {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 24000
                    });
                }
                if (audioContextRef.current.state === 'suspended') {
                    await audioContextRef.current.resume();
                }
                return audioContextRef.current;
            };

            const playSound = async (type) => {
                try {
                    const ctx = await initAudio();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    if (type === 'correct') {
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(523.25, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(1046.50, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    } else {
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(120, ctx.currentTime);
                        osc.frequency.linearRampToValueAtTime(40, ctx.currentTime + 0.2);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                        gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    }
                    osc.start();
                    osc.stop(ctx.currentTime + 0.3);
                } catch(e) {}
            };

            const speakStep = async (stepNumber, retryCount = 0) => {
                if (isSpeaking || !gameStarted) return;
                
                const messages = {
                    1: "Step 1: Identify the two main stages of oxidative phosphorylation.",
                    2: "Step 2: Locate where this process occurs in the cell.",
                    3: "Step 3: Identify the components of the electron transport chain.",
                    4: "Step 4: Finally, identify the enzyme involved in chemiosmosis."
                };

                const msgMap = {0: 1, 1: 1, 2: 2, 3: 3, 4: 3, 5: 3, 6: 3, 7: 3, 8: 3, 9: 4};
                const text = messages[msgMap[stepNumber]];
                if (!text) return;

                setIsSpeaking(true);
                try {
                    const ctx = await initAudio();
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Say clearly: ${text}` }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                            }
                        })
                    });

                    if (!response.ok && retryCount < 5) {
                        setTimeout(() => speakStep(stepNumber, retryCount + 1), 1000);
                        return;
                    }

                    const result = await response.json();
                    const pcmData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (pcmData) {
                        const binaryString = atob(pcmData);
                        const len = binaryString.length;
                        const bytes = new Int16Array(len / 2);
                        for (let i = 0; i < len; i += 2) {
                            bytes[i/2] = (binaryString.charCodeAt(i+1) << 8) | binaryString.charCodeAt(i);
                        }
                        const audioBuffer = ctx.createBuffer(1, bytes.length, 24000);
                        audioBuffer.getChannelData(0).set(Array.from(bytes).map(v => v / 32768));
                        const source = ctx.createBufferSource();
                        source.buffer = audioBuffer;
                        source.connect(ctx.destination);
                        source.start();
                    }
                } catch (e) { console.error(e); } finally { setIsSpeaking(false); }
            };

            useEffect(() => {
                const shuffled = [...gameSequence].map(item => item.text).sort(() => Math.random() - 0.5);
                setAvailableTerms(shuffled);
            }, []);

            useEffect(() => {
                if (gameStarted && [0, 2, 3, 9].includes(currentStep)) {
                    speakStep(currentStep);
                }
            }, [currentStep, gameStarted]);

            const handleDrop = async (e, targetName) => {
                e.preventDefault();
                const draggedText = e.dataTransfer.getData("text");
                const expected = gameSequence[currentStep];

                if (draggedText.toLowerCase() === expected.text.toLowerCase()) {
                    playSound('correct');
                    setCompletedTerms([...completedTerms, draggedText]);
                    setAvailableTerms(availableTerms.filter(t => t !== draggedText));
                    setCurrentStep(currentStep + 1);
                } else {
                    playSound('wrong');
                }
            };

            const startGame = async () => {
                await initAudio(); 
                setGameStarted(true);
            };

            if (!gameStarted) {
                return (
                    <div className="conquest-bg h-full w-full">
                        <div className="glass-panel flex flex-col items-center max-w-4xl mx-4 text-center">
                            <h1 className="text-6xl md:text-8xl font-black mb-6 text-sky-400 uppercase tracking-tighter drop-shadow-[0_10px_10px_rgba(0,0,0,0.5)]">
                                THE GREAT ATP CONQUEST
                            </h1>
                            <p className="mb-12 text-xl md:text-2xl text-white font-bold italic tracking-wide drop-shadow-md opacity-90">
                                "Let's master oxidative phosphorylation!"
                            </p>
                            
                            <button 
                                onClick={startGame} 
                                className="px-14 py-7 bg-sky-600 hover:bg-sky-500 rounded-full font-black text-2xl md:text-3xl transition-all shadow-[0_10px_0_0_rgb(7,89,133)] active:shadow-none active:translate-y-2 border-b-2 border-sky-300/20 flex items-center gap-4 uppercase tracking-widest cursor-pointer group text-white"
                            >
                                <span>Begin the conquest!</span>
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full bg-slate-950 text-slate-900 p-4">
                    <div className="flex justify-between items-center mb-4 px-2">
                        <div className="w-32"></div>
                        <div className="text-center">
                            <h1 className="text-3xl font-black text-white uppercase tracking-tighter">The Great ATP Conquest</h1>
                            <p className="text-xs text-sky-400 font-bold uppercase tracking-[0.3em] animate-pulse">Drag labels to complete the diagram</p>
                        </div>
                        <button 
                            onClick={() => speakStep(currentStep)}
                            className="bg-slate-800 hover:bg-slate-700 text-white px-5 py-2 rounded-full border border-slate-600 transition-all flex items-center gap-2 font-bold text-xs uppercase tracking-wider"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                            <span>Listen</span>
                        </button>
                    </div>

                    <div className="flex-1 relative border-[8px] border-slate-900 rounded-[2.5rem] overflow-hidden flex flex-col shadow-2xl">
                        {/* Intermembrane Space */}
                        <div className="h-[20%] bg-[#fffbeb] relative flex items-center justify-center border-b-[4px] border-amber-100">
                            <span className="absolute top-4 right-8 text-[11px] font-black text-red-600 bg-white/80 px-4 py-1.5 rounded-full uppercase tracking-widest shadow-sm">Intermembrane Space</span>
                        </div>

                        {/* Inner Membrane */}
                        <div className="h-[60%] bg-[#fef08a] relative flex items-center justify-evenly px-8 border-y-[4px] border-amber-300 shadow-inner">
                            <span className="absolute top-4 right-8 text-[11px] font-black text-red-600 bg-white/80 px-4 py-1.5 rounded-full uppercase tracking-widest shadow-sm">Inner Membrane</span>
                            
                            <Protein type="large" name="NADH dehydrogenase" active={currentStep===3} done={completedTerms.includes("NADH dehydrogenase")} onDrop={handleDrop} />
                            <div className="w-4"></div>
                            <Protein type="small" name="coenzyme Q" active={currentStep===5} done={completedTerms.includes("coenzyme Q")} onDrop={handleDrop} />
                            <Protein type="large" name="cytochrome c reductase" active={currentStep===6} done={completedTerms.includes("cytochrome c reductase")} onDrop={handleDrop} />
                            <Protein type="surface" name="cytochrome c" active={currentStep===7} done={completedTerms.includes("cytochrome c")} onDrop={handleDrop} />
                            <Protein type="large" name="cytochrome c oxidase" active={currentStep===8} done={completedTerms.includes("cytochrome c oxidase")} onDrop={handleDrop} />
                            <Protein type="turbine" name="ATP synthase" active={currentStep===9} done={completedTerms.includes("ATP synthase")} onDrop={handleDrop} />
                        </div>

                        {/* Matrix */}
                        <div className="h-[20%] bg-[#bbf7d0] relative border-t-[4px] border-green-300 shadow-inner">
                            <span className="absolute bottom-4 right-8 text-[11px] font-black text-red-600 bg-white/80 px-4 py-1.5 rounded-full uppercase tracking-widest shadow-sm">Matrix</span>
                            <div className="absolute top-0 left-[18%] -translate-y-1/2">
                                <Protein type="peripheral" name="succinate dehydrogenase" active={currentStep===4} done={completedTerms.includes("succinate dehydrogenase")} onDrop={handleDrop} />
                            </div>
                        </div>
                    </div>

                    <div className="mt-4 p-6 bg-white border-[3px] border-sky-100 rounded-[2rem] shadow-xl overflow-y-auto">
                        <div className="text-step-instruction">
                            <p className="mb-2">
                                1. Oxidative phosphorylation consists of <Drop target="electron transport chain" done={completedTerms.includes("electron transport chain")} active={currentStep===0} onDrop={handleDrop} /> and <Drop target="chemiosmosis" done={completedTerms.includes("chemiosmosis")} active={currentStep===1} onDrop={handleDrop} />.
                            </p>
                            
                            {currentStep >= 2 && (
                                <p className="mb-2 transition-all duration-700 animate-in fade-in slide-in-from-left-4">
                                    2. This occurs at the <Drop target="inner membrane of mitochondria" done={completedTerms.includes("inner membrane of mitochondria")} active={currentStep===2} onDrop={handleDrop} />.
                                </p>
                            )}
                            
                            {currentStep >= 3 && (
                                <p className="mb-2 transition-all duration-700 animate-in fade-in slide-in-from-left-4">
                                    3. The components of ETC are <Drop target="NADH dehydrogenase" done={completedTerms.includes("NADH dehydrogenase")} active={currentStep===3} onDrop={handleDrop} />, <Drop target="succinate dehydrogenase" done={completedTerms.includes("succinate dehydrogenase")} active={currentStep===4} onDrop={handleDrop} />, <Drop target="coenzyme Q" done={completedTerms.includes("coenzyme Q")} active={currentStep===5} onDrop={handleDrop} />, <Drop target="cytochrome c reductase" done={completedTerms.includes("cytochrome c reductase")} active={currentStep===6} onDrop={handleDrop} />, <Drop target="cytochrome c" done={completedTerms.includes("cytochrome c")} active={currentStep===7} onDrop={handleDrop} /> and <Drop target="cytochrome c oxidase" done={completedTerms.includes("cytochrome c oxidase")} active={currentStep===8} onDrop={handleDrop} />.
                                </p>
                            )}
                            
                            {currentStep >= 9 && (
                                <p className="transition-all duration-700 animate-in fade-in slide-in-from-left-4 font-semibold text-slate-900">
                                    4. Meanwhile, chemiosmosis involves <Drop target="ATP synthase" done={completedTerms.includes("ATP synthase")} active={currentStep===9} onDrop={handleDrop} />.
                                </p>
                            )}
                        </div>
                    </div>

                    <div className="mt-4 flex flex-wrap gap-2.5 justify-center bg-slate-900 p-4 rounded-3xl shadow-inner overflow-y-auto max-h-24">
                        {availableTerms.map((t, i) => (
                            <div key={i} draggable onDragStart={(e) => { e.dataTransfer.setData("text", t); }} className="px-4 py-1.5 bg-sky-500 hover:bg-sky-400 text-white rounded-xl font-bold text-xs cursor-grab active:scale-90 shadow-[0_4px_0_0_rgb(7,89,133)] transition-all uppercase tracking-widest border-b border-sky-300/20">
                                {t}
                            </div>
                        ))}
                        {availableTerms.length === 0 && <span className="text-green-400 font-black uppercase tracking-[0.2em] animate-bounce text-sm">Mission Accomplished!</span>}
                    </div>
                </div>
            );
        };

        const Drop = ({ target, done, active, onDrop }) => (
            <span onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, target)} className={`inline-flex items-center justify-center min-w-[140px] px-3 mx-1 rounded-xl transition-all border-2 align-middle font-bold ${done ? "text-green-700 border-green-100 bg-green-50 shadow-sm" : active ? "border-sky-400 border-dashed bg-sky-50 animate-pulse text-transparent h-8" : "border-slate-200 border-dashed bg-slate-50 text-transparent h-8"}`}>
                {done ? target : ""}
            </span>
        );

        const Protein = ({ type, name, active, done, onDrop }) => {
            const fmt = (n) => n.replace(/atp/gi, "ATP").replace(/nadh/gi, "NADH").replace(/coenzyme q/gi, "coenzyme Q");
            let base = "relative flex items-center justify-center transition-all duration-500 shadow-xl ";
            let color = done ? (name === "ATP synthase" ? "bg-gradient-to-b from-purple-500 to-purple-700 border-purple-300" : "bg-gradient-to-b from-blue-500 to-blue-700 border-blue-300") : "bg-rose-200 border-rose-300 opacity-60";
            
            if (type === "large") base += `w-14 h-[110%] rounded-2xl border-2 ${color}`;
            else if (type === "peripheral") base += `w-15 h-14 rounded-b-2xl border-2 ${color}`;
            else if (type === "small") base += `w-10 h-10 rounded-full border-2 ${color}`;
            else if (type === "surface") base += `w-9 h-9 rounded-full self-start mt-[-20px] border-2 ${color}`;
            else if (type === "turbine") base += `w-20 h-[125%] rounded-t-[3.5rem] border-2 ${color}`;

            return (
                <div className={`${base} ${active ? 'scale-125 ring-4 ring-sky-400 z-50 shadow-2xl opacity-100' : ''}`} onDragOver={e => e.preventDefault()} onDrop={e => onDrop && onDrop(e, name)}>
                    <div className="protein-label text-center px-1 select-none text-white drop-shadow-md">{done ? fmt(name) : "?"}</div>
                    {active && (
                        <div className="absolute -top-16 bg-red-600 text-white text-[10px] px-3 py-1.5 rounded-lg animate-bounce font-black shadow-[0_5px_0_0_rgb(153,0,0)] whitespace-nowrap z-[100] border-2 border-white uppercase tracking-tighter">
                            Place Label
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>