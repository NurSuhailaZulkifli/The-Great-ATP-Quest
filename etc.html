<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>II: The Amazing Electron Trail</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
        
        body { 
            background-color: #020617; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-family: 'Inter', sans-serif;
        }
        
        .protein-label { 
            font-size: 10px; 
            line-height: 1.1; 
            font-weight: 800; 
            white-space: nowrap; 
            pointer-events: none;
            width: auto;
            min-width: 80px;
        }

        @keyframes turbine-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-turbine {
            animation: turbine-rotate 3s linear infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        /* Initial transfers */
        @keyframes e-transfer-nadh {
            0% { transform: translate(0, 0) scale(1.2); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translate(145px, -70px) scale(0.9); opacity: 1; }
        }
        
        @keyframes e-transfer-fadh {
            0% { transform: translate(0, 0) scale(1.2); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translate(222px, -58px) scale(0.9); opacity: 1; }
        }

        /* Sequential Chain Flow */
        @keyframes chain-flow-nadh {
            0% { transform: translate(145px, -70px); opacity: 1; } 
            15%, 25% { transform: translate(328px, -135px); opacity: 1; }
            40%, 50% { transform: translate(422px, -70px); opacity: 1; }
            65%, 75% { transform: translate(505px, -190px); opacity: 1; }
            90%, 100% { transform: translate(610px, -70px); opacity: 1; }
        }

        @keyframes chain-flow-fadh {
            0%, 50% { transform: translate(222px, -58px); opacity: 1; } 
            58%, 63% { transform: translate(290px, -118px); opacity: 1; }
            70%, 75% { transform: translate(384px, -72px); opacity: 1; }
            82%, 87% { transform: translate(460px, -180px); opacity: 1; }
            94%, 100% { transform: translate(569px, -72px); opacity: 1; }
        }

        /* Star Entry and Disappear */
        @keyframes star-lifecycle-matrix {
            0%, 50% { transform: translate(569px, -72px) scale(1); opacity: 1; }
            60% { transform: translate(570px, 40px) scale(1); opacity: 1; }
            61%, 100% { transform: translate(610px, 40px) scale(0); opacity: 0; }
        }

        /* H+ Fusion and Disappear */
        @keyframes h-ion-fuse-strict {
            0% { transform: translate(var(--tx), var(--ty)); opacity: 1; }
            66% { transform: translate(570px, 40px); opacity: 1; }
            61%, 100% { transform: translate(610px, 40px); opacity: 0; }
        }

        /* Water Lifecycle */
        @keyframes water-lifecycle {
            0% { opacity: 0; transform: translate(570px, 40px) scale(0.5); background-color: transparent; }
            10% { opacity: 1; transform: translate(570px, 40px) scale(1); background-color: rgba(45, 212, 191, 0.2); border-color: #2dd4bf; }
            59% { background-color: rgba(45, 212, 191, 0.2); transform: translate(610px, 40px) scale(1); }
            60% { background-color: #2dd4bf; transform: translate(610px, 40px) scale(1.2); }
            85% { background-color: #2dd4bf; transform: translate(610px, 40px) scale(1.2); opacity: 1; }
            100% { transform: translate(150px, 50px) scale(0); opacity: 0; }
        }

        /* Equation Pause and Exit */
        @keyframes equation-lifecycle {
            0% { opacity: 0; transform: scale(0.9); }
            10%, 75% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: translate(50px, 20px) scale(0.8); }
        }

        @keyframes label-morph {
            0%, 59% { content: "½O₂"; }
            60%, 100% { content: "H₂O"; }
        }

        .water-molecule-strict::after {
            content: "½O₂";
            animation: label-morph 5s forwards linear;
            animation-delay: inherit;
        }

        .animate-e-nadh-once { animation: e-transfer-nadh 3s forwards ease-in-out; }
        .animate-e-fadh-once { animation: e-transfer-fadh 3s forwards ease-in-out; }
        .animate-chain-nadh { animation: chain-flow-nadh 8s forwards linear; }
        .animate-chain-fadh { animation: chain-flow-fadh 16s forwards linear; }

        .animate-star-step12 { animation: star-lifecycle-matrix 5s forwards linear; }
        .animate-h-step12 { animation: h-ion-fuse-strict 5s forwards linear; }
        .animate-water-step12 { animation: water-lifecycle 5s forwards ease-in-out; }
        .animate-eq-step12 { animation: equation-lifecycle 5s forwards ease-in-out; }

        .animate-proton-once { animation: proton-release 2s forwards ease-out; }
        @keyframes proton-release {
            0% { transform: translate(0, 0) scale(1); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(1); opacity: 1; }
        }
        
        .highlight-protein {
            box-shadow: 0 0 20px 5px rgba(250, 204, 21, 0.6);
            border-color: #facc15 !important;
            transition: all 0.5s ease-in-out;
        }

        .equation-glow {
            text-shadow: 0 0 10px rgba(45, 212, 191, 0.8);
        }
    </style>
</head>
<body>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SevenPointStar = ({ className }) => (
            <svg viewBox="0 0 100 100" className={className} fill="#FACC15" stroke="#854D0E" strokeWidth="1">
                <path d="M50,5 L58.9,34.5 L89.1,27.3 L72.7,53.4 L93.6,76.5 L63.6,74.5 L50,95 L36.4,74.5 L6.4,76.5 L27.3,53.4 L10.9,27.3 L41.1,34.5 Z" />
            </svg>
        );

        const App = () => {
            const [currentStep, setCurrentStep] = useState(0);
            const [completedTerms, setCompletedTerms] = useState([]);
            const [availableTerms, setAvailableTerms] = useState([]);
            const [showPhaseTwo, setShowPhaseTwo] = useState(false);
            const [delayStep7, setDelayStep7] = useState(false);
            const [delayStep11, setDelayStep11] = useState(false);
            const [showFinish, setShowFinish] = useState(false);
            const audioContextRef = useRef(null);

            const gameSequence = [
                { text: "glycolysis", step: 0 },
                { text: "pyruvate oxidation", step: 1 },
                { text: "Krebs cycle", step: 2 },
                { text: "NAD+", step: 3 },
                { text: "Krebs cycle", step: 4 },
                { text: "FAD", step: 5 },
                { text: "Coenzyme Q", step: 6 },
                { text: "cytochrome c reductase", step: 7 },
                { text: "cytochrome c", step: 8 },
                { text: "redox", step: 9 },
                { text: "final electron acceptor", step: 10 },
                { text: "water", step: 11 }
            ];

            const speak = (text) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.95;
                utterance.pitch = 1;
                window.speechSynthesis.speak(utterance);
            };

            const initAudio = async () => {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContextRef.current.state === 'suspended') {
                    await audioContextRef.current.resume();
                }
            };

            const playSound = async (type) => {
                try {
                    await initAudio();
                    const ctx = audioContextRef.current;
                    if (type === 'victory') {
                        const tempo = 0.15;
                        const playNote = (freq, start, duration) => {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.type = 'square';
                            osc.frequency.setValueAtTime(freq, ctx.currentTime + start);
                            gain.gain.setValueAtTime(0.2, ctx.currentTime + start);
                            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + start + duration);
                            osc.connect(gain); gain.connect(ctx.destination);
                            osc.start(ctx.currentTime + start); osc.stop(ctx.currentTime + start + duration);
                        };
                        playNote(261.63, 0, tempo); playNote(329.63, tempo, tempo); playNote(392.00, tempo * 2, tempo); playNote(523.25, tempo * 3, tempo * 4);
                        return;
                    }
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    if (type === 'correct') {
                        osc.frequency.setValueAtTime(600, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    } else {
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, ctx.currentTime);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    }
                    osc.start(); osc.stop(ctx.currentTime + 0.2);
                } catch(e) {}
            };

            useEffect(() => {
                if (currentStep === 4 && !delayStep7) {
                    const timer = setTimeout(() => {
                        setDelayStep7(true);
                    }, 4000);
                    return () => clearTimeout(timer);
                }
                if (currentStep === 6) {
                    const timer = setTimeout(() => {
                        setShowPhaseTwo(true);
                    }, 5000);
                    return () => clearTimeout(timer);
                }
                if (currentStep === 10 && !delayStep11) {
                    const timer = setTimeout(() => {
                        setDelayStep11(true);
                    }, 18000);
                    return () => clearTimeout(timer);
                }
                // Trigger finish button after 2nd water animation finishes
                if (currentStep === 12) {
                    const timer = setTimeout(() => {
                        setShowFinish(true);
                        playSound('victory');
                    }, 11500); // Staggered cycle duration (5+5) + buffer
                    return () => clearTimeout(timer);
                }
            }, [currentStep]);

            useEffect(() => {
                const stepMapping = {
                    0: "Step 5. Identify the sources of NADH.",
                    3: "Step 6. What is formed when NADH is oxidized?",
                    4: "Step 7. Identify the source of FADH2.",
                    5: "Step 8. What is formed when FADH2 is oxidized?",
                    6: "Step 9. Which component these electrons will be transferred to?",
                    7: "Step 10. Identify the next components and reaction involved.",
                    10: "Step 11. What is the function of oxygen in E.T.C.?",
                    11: "Step 12. What is the name of by-products?"
                };
                if (currentStep === 4) { if (delayStep7) speak(stepMapping[4]); }
                else if (currentStep === 10) { if (delayStep11) speak(stepMapping[10]); }
                else if (currentStep >= 6) { if (showPhaseTwo && stepMapping[currentStep]) speak(stepMapping[currentStep]); }
                else if (stepMapping[currentStep]) { speak(stepMapping[currentStep]); }
            }, [currentStep, showPhaseTwo, delayStep7, delayStep11]);

            useEffect(() => {
                const phase1Terms = ["glycolysis", "pyruvate oxidation", "Krebs cycle", "NAD+", "FAD"];
                const phase2Terms = ["Coenzyme Q", "cytochrome c reductase", "cytochrome c", "redox", "final electron acceptor", "water"];
                let terms = !showPhaseTwo ? phase1Terms : phase2Terms;
                const shuffled = [...terms].sort(() => Math.random() - 0.5);
                setAvailableTerms(shuffled);
            }, [showPhaseTwo]);

            const handleDrop = (e, indexInSequence) => {
                e.preventDefault();
                const draggedText = e.dataTransfer.getData("text");
                const expected = gameSequence[indexInSequence];
                if (draggedText.toLowerCase() === expected.text.toLowerCase()) {
                    playSound('correct');
                    setCompletedTerms(prev => [...prev, { text: draggedText, step: indexInSequence }]);
                    const remainingNeeded = gameSequence.slice(indexInSequence + 1).some(item => item.text.toLowerCase() === draggedText.toLowerCase());
                    if (!remainingNeeded) { setAvailableTerms(prev => prev.filter(t => t.toLowerCase() !== draggedText.toLowerCase())); }
                    setCurrentStep(prev => prev + 1);
                } else { playSound('wrong'); }
            };

            const isDone = (stepIdx) => completedTerms.some(item => item.step === stepIdx);
            const formatDisplay = (text) => {
                if (text.toLowerCase() === "nad+") return "NAD⁺";
                if (text.toLowerCase() === "fad") return "FAD";
                if (text.toLowerCase() === "krebs cycle") return "Krebs cycle";
                return text;
            };
            const formatProteinDisplay = (text) => {
                const lower = text.toLowerCase();
                return lower.replace("nadh", "NADH").replace("coenzyme q", "coenzyme Q").replace("atp", "ATP");
            };

            const isNadhOxidized = isDone(3);
            const isFadhOxidized = isDone(5);
            const isStep10Done = isDone(9);
            const isStep12Done = isDone(11);
            const CYCLE_DURATION = 5;
            const CYCLE2_DELAY = CYCLE_DURATION + 1.0;

            return (
                <div className="flex flex-col h-full bg-slate-950 p-6 overflow-hidden">
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex flex-col">
                            <h2 className="text-3xl font-black text-white uppercase tracking-tighter">II: The Amazing Electron Trail</h2>
                            <div className="flex items-center gap-3">
                                <span className="text-sky-400 text-sm font-bold tracking-widest">Trace the flow of energy in the electron transport chain</span>
                            </div>
                        </div>
                        <div className="flex gap-4">
                            {showFinish && (
                                <a 
                                    href="index.html" 
                                    className="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-black rounded-xl uppercase text-xs tracking-widest transition-all shadow-xl animate-bounce border-b-4 border-emerald-800"
                                >
                                    Trail complete! Mission successful! →
                                </a>
                            )}
                        </div>
                    </div>

                    <div className="flex flex-1 gap-6 overflow-hidden items-center justify-center">
                        <div className="flex-1 h-full relative border-[10px] border-slate-900 rounded-[3rem] overflow-hidden flex flex-col shadow-2xl bg-white">
                            <div className="h-[22%] bg-amber-50 relative flex items-center border-b-[4px] border-amber-100 px-10">
                                <span className="text-xs font-black text-black tracking-[0.05em] bg-white/40 px-2 py-0.5 rounded absolute left-10">Intermembrane Space</span>
                            </div>

                            <div className="h-[45%] bg-amber-100 relative flex items-center justify-start gap-8 px-56 border-y-[4px] border-amber-200">
                                <span className="absolute bottom-4 left-10 text-xs font-black text-black tracking-[0.05em] bg-white/40 px-2 py-0.5 rounded">Inner Membrane</span>
                                <Protein type="integral" name="NADH dehydrogenase" formatFn={formatProteinDisplay} highlighted={isNadhOxidized} />
                                <Protein type="peripheral-matrix" name="succinate dehydrogenase" formatFn={formatProteinDisplay} highlighted={isFadhOxidized} />
                                <Protein type="small" name="coenzyme Q" formatFn={formatProteinDisplay} highlighted={isDone(6)} />
                                <Protein type="integral" name="cytochrome c reductase" formatFn={formatProteinDisplay} highlighted={isDone(7)} />
                                <Protein type="surface" name="cytochrome c" formatFn={formatProteinDisplay} highlighted={isDone(8)} />
                                <Protein type="integral" name="cytochrome c oxidase" formatFn={formatProteinDisplay} highlighted={isDone(9)} />
                                <div className="ml-auto pr-8 h-full flex items-center">
                                    <Protein type="turbine" name="ATP synthase" formatFn={formatProteinDisplay} />
                                </div>
                            </div>

                            <div className="h-[33%] bg-emerald-50 relative border-t-[4px] border-emerald-100">
                                <div className="absolute top-4 left-12 flex gap-12">
                                    <div className="relative flex flex-col items-center animate-float" style={{animationDelay: '0s'}}>
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center border-2 transition-all duration-1000 shadow-lg ${isNadhOxidized ? 'bg-orange-100 border-orange-400' : 'bg-orange-500 border-orange-200'}`}>
                                            <span className={`text-[10px] font-black tracking-tight transition-colors ${isNadhOxidized ? 'text-orange-600' : 'text-white'}`}>
                                                {isNadhOxidized ? "NAD⁺" : "NADH"}
                                            </span>
                                        </div>
                                        {isNadhOxidized && (
                                            <>
                                                <div className={`absolute top-2 left-2 flex items-center justify-center 
                                                    ${isStep12Done ? 'animate-star-step12' : isStep10Done ? 'animate-chain-nadh' : 'animate-e-nadh-once'}`}
                                                     style={{animationFillMode: 'forwards', animationDelay: '0s'}}>
                                                    <SevenPointStar className="w-12 h-12 drop-shadow-[0_0_12px_rgba(251,191,36,1)]" />
                                                    <span className="absolute text-[9px] font-black text-black">2e⁻</span>
                                                </div>
                                                <div className={`absolute bottom-[-10px] w-[28.8px] h-[28.8px] bg-slate-300 rounded-full flex items-center justify-center border-2 border-white shadow-[0_0_10px_rgba(203,213,225,0.8)] ${isStep12Done ? 'animate-h-step12' : 'animate-proton-once'}`} 
                                                     style={{animationDelay: isStep12Done ? '0.2s' : '0.4s', '--tx': '160px', '--ty': '-15px'}}>
                                                    <span className="text-[10px] font-black text-slate-800 leading-none">H⁺</span>
                                                </div>
                                                <div className={`absolute bottom-[-10px] w-[28.8px] h-[28.8px] bg-slate-300 rounded-full flex items-center justify-center border-2 border-white shadow-[0_0_10px_rgba(203,213,225,0.8)] ${isStep12Done ? 'animate-h-step12' : 'animate-proton-once'}`} 
                                                     style={{animationDelay: isStep12Done ? '0.4s' : '0.8s', '--tx': '200px', '--ty': '-5px'}}>
                                                    <span className="text-[10px] font-black text-slate-800 leading-none">H⁺</span>
                                                </div>
                                            </>
                                        )}
                                    </div>

                                    <div className="relative flex flex-col items-center animate-float" style={{animationDelay: '1.5s'}}>
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center border-2 transition-all duration-1000 shadow-lg ${isFadhOxidized ? 'bg-red-100 border-red-400' : 'bg-red-600 border-red-200'}`}>
                                            <span className={`text-[10px] font-black tracking-tight transition-colors ${isFadhOxidized ? 'text-red-600' : 'text-white'}`}>
                                                {isFadhOxidized ? "FAD" : "FADH₂"}
                                            </span>
                                        </div>
                                        {isFadhOxidized && (
                                            <>
                                                <div className={`absolute top-0 left-0 flex items-center justify-center 
                                                    ${isStep12Done ? 'animate-star-step12' : isStep10Done ? 'animate-chain-fadh' : 'animate-e-fadh-once'}`}
                                                     style={{
                                                     animationDelay: isStep12Done ? `${CYCLE2_DELAY}s` : '0s',
                                                     animationFillMode: 'both'
                                                   }}>
                                                    <SevenPointStar className="w-12 h-12 drop-shadow-[0_0_12px_rgba(251,191,36,1)]" />
                                                    <span className="absolute text-[9px] font-black text-black">2e⁻</span>
                                                </div>
                                                <div className={`absolute bottom-[-10px] w-[28.8px] h-[28.8px] bg-slate-300 rounded-full flex items-center justify-center border-2 border-white shadow-[0_0_10px_rgba(203,213,225,0.8)] ${isStep12Done ? 'animate-h-step12' : 'animate-proton-once'}`} 
                                                     style={{animationDelay: isStep12Done ? `${CYCLE2_DELAY + 0.2}s` : '0.4s', '--tx': '280px', '--ty': '-15px'}}>
                                                    <span className="text-[10px] font-black text-slate-800 leading-none">H⁺</span>
                                                </div>
                                                <div className={`absolute bottom-[-10px] w-[28.8px] h-[28.8px] bg-slate-300 rounded-full flex items-center justify-center border-2 border-white shadow-[0_0_10px_rgba(203,213,225,0.8)] ${isStep12Done ? 'animate-h-step12' : 'animate-proton-once'}`} 
                                                     style={{animationDelay: isStep12Done ? `${CYCLE2_DELAY + 0.4}s` : '0.8s', '--tx': '320px', '--ty': '-5px'}}>
                                                    <span className="text-[10px] font-black text-slate-800 leading-none">H⁺</span>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>

                                <div className="absolute top-0 left-0 w-full h-full pointer-events-none">
                                    {isStep12Done && (
                                        <>
                                            {/* NADH Water */}
                                            <div className="water-molecule-strict absolute w-14 h-14 -translate-x-1/2 -translate-y-1/2 rounded-full border-2 flex items-center justify-center shadow-lg animate-water-step12 text-[10px] font-black text-slate-800" 
                                                 style={{left: '0px', top: '0px', animationDelay: '0s'}}></div>

                                            {/* FADH2 Water */}
                                            <div className="water-molecule-strict absolute w-14 h-14 -translate-x-1/2 -translate-y-1/2 rounded-full border-2 flex items-center justify-center shadow-lg animate-water-step12 text-[10px] font-black text-slate-800" 
                                                 style={{left: '0px', top: '0px', animationDelay: `${CYCLE2_DELAY}s`}}></div>
                                        </>
                                    )}
                                </div>

                                <div className="absolute right-[80px] top-[40px]">
                                    {isStep12Done && (
                                        <>
                                            <div className="whitespace-nowrap bg-slate-900/90 px-4 py-2 rounded-full border-2 border-teal-500/50 animate-eq-step12" style={{animationDelay: '0s'}}>
                                                <span className="text-teal-400 font-black text-sm equation-glow tracking-wider">½O₂ + 2e⁻ + 2H⁺ → H₂O</span>
                                            </div>
                                            <div className="absolute top-0 whitespace-nowrap bg-slate-900/90 px-4 py-2 rounded-full border-2 border-teal-500/50 animate-eq-step12" style={{animationDelay: `${CYCLE2_DELAY}s`}}>
                                                <span className="text-teal-400 font-black text-sm equation-glow tracking-wider">½O₂ + 2e⁻ + 2H⁺ → H₂O</span>
                                            </div>
                                        </>
                                    )}
                                </div>
                                <span className="absolute bottom-4 left-10 text-xs font-black text-black tracking-[0.05em] bg-white/40 px-2 py-0.5 rounded">Matrix</span>
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 p-8 bg-slate-900 rounded-[2rem] border border-slate-800 shadow-xl relative overflow-hidden font-bold">
                        <div className="text-white mb-6 min-h-[10rem]">
                            {!showPhaseTwo ? (
                                <div className="text-xl leading-relaxed space-y-4">
                                    <div>5. NADH from <Drop target="glycolysis" done={isDone(0)} active={currentStep===0} onDrop={(e) => handleDrop(e, 0)} formatFn={formatDisplay} />, <Drop target="pyruvate oxidation" done={isDone(1)} active={currentStep===1} onDrop={(e) => handleDrop(e, 1)} formatFn={formatDisplay} /> and <Drop target="Krebs cycle" done={isDone(2)} active={currentStep===2} onDrop={(e) => handleDrop(e, 2)} formatFn={formatDisplay} /> transfer their electrons to NADH dehydrogenase.</div>
                                    {(currentStep >= 3 || isDone(3)) && (<div>6. NADH is oxidized to <Drop target="NAD+" done={isDone(3)} active={currentStep===3} onDrop={(e) => handleDrop(e, 3)} formatFn={formatDisplay} />.</div>)}
                                    {(delayStep7 && (currentStep >= 4 || isDone(4))) && (<div>7. FADH₂ produced from <Drop target="Krebs cycle" done={isDone(4)} active={currentStep===4} onDrop={(e) => handleDrop(e, 4)} formatFn={formatDisplay} /> transfer their electrons to succinate dehydrogenase.</div>)}
                                    {(currentStep >= 5 || isDone(5)) && (<div>8. FADH₂ is oxidized to <Drop target="FAD" done={isDone(5)} active={currentStep===5} onDrop={(e) => handleDrop(e, 5)} formatFn={formatDisplay} />.</div>)}
                                </div>
                            ) : (
                                <div className="text-xl leading-relaxed space-y-4">
                                    <div>9. These electrons from NADH dehydrogenase and succinate dehydrogenase are then transferred to <Drop target="Coenzyme Q" done={isDone(6)} active={currentStep===6} onDrop={(e) => handleDrop(e, 6)} formatFn={formatDisplay} />.</div>
                                    {(currentStep >= 7 || isDone(7)) && (<div>10. along a series of electron transport chain which consist of <Drop target="cytochrome c reductase" done={isDone(7)} active={currentStep===7} onDrop={(e) => handleDrop(e, 7)} formatFn={formatDisplay} />, <Drop target="cytochrome c" done={isDone(8)} active={currentStep===8} onDrop={(e) => handleDrop(e, 8)} formatFn={formatDisplay} /> and cytochrome c oxidase through a <Drop target="redox" done={isDone(9)} active={currentStep===9} onDrop={(e) => handleDrop(e, 9)} formatFn={formatDisplay} /> reaction.</div>)}
                                    {((currentStep >= 10 || isDone(10)) && delayStep11) && (<div>11. Electrons is then transferred to oxygen which act as <Drop target="final electron acceptor" done={isDone(10)} active={currentStep===10} onDrop={(e) => handleDrop(e, 10)} formatFn={formatDisplay} /> in aerobic respiration.</div>)}
                                    {(currentStep >= 11 || isDone(11)) && (<div>12. Oxygen combines with electrons and hydrogen ions to form <Drop target="water" done={isDone(11)} active={currentStep===11} onDrop={(e) => handleDrop(e, 11)} formatFn={formatDisplay} />.</div>)}
                                </div>
                            )}
                        </div>
                        <div className="flex flex-wrap gap-4 justify-center">
                            {availableTerms.map((t, i) => (
                                <div key={`${showPhaseTwo ? 'p2' : 'p1'}-${i}`} draggable onDragStart={(e) => { e.dataTransfer.setData("text", t); }} className="px-6 py-3 bg-sky-600 hover:bg-sky-500 text-white rounded-xl font-black text-sm cursor-grab active:scale-95 transition-all uppercase tracking-widest shadow-lg border-b-4 border-sky-800">{formatDisplay(t)}</div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Drop = ({ target, done, active, onDrop, formatFn }) => (
            <span onDragOver={e => e.preventDefault()} onDrop={onDrop} className={`inline-flex items-center justify-center min-w-[140px] px-3 mx-1 rounded-lg transition-all border-2 align-middle font-black text-base ${done ? "text-sky-300 border-sky-500/30 bg-sky-500/10" : active ? "border-red-400 border-dashed bg-red-500/20 animate-pulse text-red-500 text-xl" : "border-slate-700 border-dashed bg-slate-800/50 text-transparent h-7"}`}>{done ? formatFn(target) : (active ? "?" : "")}</span>
        );

        const Protein = ({ type, name, formatFn, highlighted }) => {
            const label = formatFn(name);
            let highlightedClass = highlighted ? "highlight-protein" : "";
            if (type === "integral") return <div className={`relative flex flex-col items-center justify-center transition-all duration-500 w-16 h-[130%] rounded-2xl border-2 bg-gradient-to-b from-sky-400 to-sky-600 border-sky-300 ring-2 ring-white/20 shadow-lg ${highlightedClass}`}><div className="protein-label text-center px-1 text-black">{label}</div></div>;
            if (type === "peripheral-matrix") return <div className="relative flex flex-col items-center self-end h-24 mb-[-3.5rem] overflow-visible"><div className={`w-16 h-12 rounded-2xl border-2 transition-all duration-500 flex items-center justify-center bg-gradient-to-b from-sky-400 to-sky-600 border-sky-300 ring-2 ring-white/20 shadow-lg ${highlightedClass}`}><div className="protein-label text-center text-black px-1 leading-tight">{label}</div></div></div>;
            if (type === "small") return <div className={`relative flex flex-col items-center justify-center transition-all duration-500 w-14 h-14 rounded-full border-2 -mt-12 bg-gradient-to-b from-sky-400 to-sky-600 border-sky-300 ring-2 ring-white/20 shadow-lg ${highlightedClass}`}><div className="protein-label text-center px-1 text-black">{label}</div></div>;
            if (type === "surface") return <div className={`relative flex flex-col items-center justify-center transition-all duration-500 w-12 h-12 rounded-full self-start -mt-8 border-2 bg-gradient-to-b from-sky-400 to-sky-600 border-sky-300 ring-2 ring-white/20 shadow-lg ${highlightedClass}`}><div className="protein-label text-center px-1 text-black">{label}</div></div>;
            if (type === "turbine") return <div className="relative flex flex-col items-center transition-all duration-500 w-16 h-full"><div className="w-14 h-1/2 border-2 bg-gradient-to-b from-purple-400 to-purple-600 border-purple-300 rounded-lg shadow-sm flex items-center justify-center relative -mt-10"></div><div className="w-4 h-6 border-x-2 bg-gradient-to-b from-purple-400 to-purple-600 border-purple-300"></div><div className="w-20 h-20 -mt-2 border-2 bg-gradient-to-b from-purple-400 to-purple-600 border-purple-300 rounded-full shadow-lg flex items-center justify-center relative"><div className="absolute inset-0 animate-turbine opacity-20"><div className="absolute top-0 left-1/2 -translate-x-1/2 w-2 h-full bg-white"></div><div className="absolute left-0 top-1/2 -translate-y-1/2 w-full h-2 bg-white"></div></div><div className="protein-label text-center px-1 z-10 text-white">{label}</div></div></div>;
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>